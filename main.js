(()=>{"use strict";function t(t){t.classList.add("popup_is-opened"),t.addEventListener("click",n),document.addEventListener("keydown",r);var o=t.querySelector(".popup__close");o&&o.addEventListener("click",(function(){return e(t)}))}function e(t){t.classList.remove("popup_is-opened"),t.removeEventListener("click",n),document.removeEventListener("keydown",r),function(t){t.querySelectorAll(".popup__error").forEach((function(t){t.textContent="",t.classList.remove("popup__error_visible")})),t.querySelectorAll(".popup__input").forEach((function(t){t.style.borderColor=""}))}(t),function(t){var e=t.querySelector(".popup__button");e&&(e.classList.add("popup__button_disabled"),e.setAttribute("disabled",!0))}(t)}function n(t){t.target.classList.contains("popup_is-opened")&&e(t.target)}function r(t){if("Escape"===t.key){var n=document.querySelector(".popup_is-opened");n&&e(n)}}var o={ENDPOINT:"https://nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"66eab246-0801-4172-ab93-8eafbea8dab5","Content-Type":"application/json"}},a=document.querySelector("#card-template").content,c=document.querySelector(".places__list");function i(t,n,r,c,i,u,p){var l=a.querySelector(".card").cloneNode(!0),s=l.querySelector(".card__image"),d=l.querySelector(".card__title");s.src=t.link,s.alt=t.name;var f=l.querySelector(".card__like-button"),_=l.querySelector(".card__delete-button");d.textContent=t.name;var m=Array.isArray(t.likes)?t.likes:[];return f.dataset.like=m.length,t.likes.some((function(t){return t._id===u}))&&f.classList.add("card__like-button_is-active"),f.addEventListener("click",(function(){!function(t,e){var n=e.classList.contains("card__like-button_is-active")?"DELETE":"PUT";fetch("".concat(o.ENDPOINT,"/cards/likes/").concat(t),{method:n,headers:o.headers}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))})).then((function(t){e.classList.toggle("card__like-button_is-active"),e.dataset.like=t.likes.length;var n=e.querySelector(".card__like-count");n&&(n.textContent=t.likes.length)})).catch((function(t){return console.error("Ошибка при обновлении лайка:",t)}))}(t._id,f)})),t.owner._id!==u&&(_.style.display="none"),s.addEventListener("click",(function(){c.src=s.src,i.textContent=d.textContent,n(r)})),_.addEventListener("click",(function(){n(p),p.querySelector(".popup__button").addEventListener("click",(function(n){var r,a,c;n.preventDefault(),(r=t._id,a=document.querySelector(".popup__button_confirm"),c=a.textContent,a.textContent="Удаление...",fetch("".concat(o.ENDPOINT,"/cards/").concat(r),{method:"DELETE",headers:o.headers}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))})).catch((function(t){console.error("Ошибка при добавлении новой карточки:",t)})).finally((function(){a.textContent=c}))).then((function(){l.remove(),e(p)})).catch((function(t){console.error("Ошибка при удалении карточки:",t),e(p)}))}))})),l}function u(t,e,n){var r=t.every((function(t){return t.validity.valid}));e.classList.toggle(n.inactiveButtonClass,!r),e.disabled=!r}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}var l,s=Object.fromEntries(Object.entries({profilePopup:".popup_type_edit",profileForm:".popup__form",profileAvatar:".profile__image",nameInput:".popup__input_type_name",jobInput:".popup__input_type_description",profileTitle:".profile__title",profileDescription:".profile__description",editButton:".profile__edit-button",cardPopup:".popup_type_new-card",cardForm:".popup__form",placeNameInput:".popup__input_type_card-name",linkInput:".popup__input_type_url",imagePopup:".popup_type_image",imageElement:".popup__image",captionElement:".popup__caption",addButton:".profile__add-button",confirmPopup:".popup_confirm",placesList:".places__list",popupChangeAvatar:".popup_change-avatar",avatarForm:".popup__form-change",avatarInput:".popup__input_avatar"}).map((function(t){var e,n,r=(n=2,function(t){if(Array.isArray(t))return t}(e=t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,a,c,i=[],u=!0,p=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=a.call(n)).done)&&(i.push(r.value),i.length!==e);u=!0);}catch(t){p=!0,o=t}finally{try{if(!u&&null!=n.return&&(c=n.return(),Object(c)!==c))return}finally{if(p)throw o}}return i}}(e,n)||function(t,e){if(t){if("string"==typeof t)return p(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?p(t,e):void 0}}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),o=r[0],a=r[1];return[o,document.querySelector(a)]})));function d(t){s.profileTitle.textContent=t.name,s.profileDescription.textContent=t.about,s.profileAvatar.style.backgroundImage="url(".concat(t.avatar,")"),s.profileAvatar.alt="Аватар пользователя ".concat(t.name)}function f(t){t.reset()}l={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},document.querySelectorAll(l.formSelector).forEach((function(t){return function(t,e){var n=Array.from(t.querySelectorAll(e.inputSelector)),r=t.querySelector(e.submitButtonSelector);u(n,r,e),n.forEach((function(o){o.addEventListener("input",(function(){!function(t,e,n){var r=e.querySelector(".popup__error_type_".concat(t.name));t.validity.valid?function(t,e,n){e.textContent="",e.classList.remove(n.errorClass),t.style.borderColor=""}(t,r,n):function(t,e,n){e.textContent=t.validity.valueMissing?"Вы пропустили это поле.":t.validity.typeMismatch&&"url"===t.type?"Не ссылка":t.validity.tooShort?"Минимум: ".concat(t.minLength,", сейчас: ").concat(t.value.length,"."):t.validationMessage,e.classList.add(n.errorClass),t.style.borderColor="#FF0000"}(t,r,n)}(o,t,e),u(n,r,e)}))}))}(t,l)})),fetch("".concat(o.ENDPOINT,"/users/me"),{method:"GET",headers:o.headers}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))})).catch((function(t){console.error("Ошибка при загрузке информации о пользователе:",t)})).then((function(e){d(e);var n=e._id;return fetch("".concat(o.ENDPOINT,"/cards"),{method:"GET",headers:o.headers}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))})).then((function(t){return Array.isArray(t)?t:Promise.reject("Ответ не является массивом")})).catch((function(t){console.error("Ошибка при получении карточек:",t)})).then((function(e){if(!Array.isArray(e))throw new Error("Invalid data format: cards is not an array");!function(t,e,n,r,o,a,u){Array.isArray(t)&&t.forEach((function(t){var p=i(t,e,n,r,o,a,u);c.append(p)}))}(e,t,s.imagePopup,s.imageElement,s.captionElement,n,s.confirmPopup)}))})).catch((function(t){return console.error("Initialization error:",t)})),s.editButton.addEventListener("click",(function(){s.nameInput.value=s.profileTitle.textContent,s.jobInput.value=s.profileDescription.textContent,t(s.profilePopup)})),s.profileForm.addEventListener("submit",(function(t){var n,r,a,c;t.preventDefault(),(n=s.nameInput.value,r=s.jobInput.value,a=document.querySelector(".popup__button"),c=a.textContent,a.textContent="Сохранение...",fetch("".concat(o.ENDPOINT,"/users/me"),{method:"PATCH",headers:o.headers,body:JSON.stringify({name:n,about:r})}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))})).then((function(t){return t&&t.name&&t.about&&t.avatar?t:Promise.reject("Некорректный ответ от сервера")})).catch((function(t){return console.error("Ошибка при обновлении данных пользователя:",t),Promise.reject(t)})).finally((function(){a.textContent=c}))).then((function(t){d(t),e(s.profilePopup)})).catch((function(t){return console.error("Profile update error:",t)}))})),s.addButton.addEventListener("click",(function(){f(s.cardForm),t(s.cardPopup)})),s.cardForm.addEventListener("submit",(function(n){var r,a,c,u;n.preventDefault(),(r=s.placeNameInput.value,a=s.linkInput.value,c=document.querySelector(".popup__button-new-card"),u=c.textContent,c.textContent="Создание...",fetch("".concat(o.ENDPOINT,"/cards"),{method:"POST",headers:o.headers,body:JSON.stringify({name:r,link:a})}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))})).catch((function(t){console.error("Ошибка при добавлении новой карточки:",t)})).finally((function(){c.textContent=u}))).then((function(n){var r=i(n,t,s.imagePopup,s.imageElement,s.captionElement,n.owner._id,s.confirmPopup);s.placesList.prepend(r),e(s.cardPopup),f(s.cardForm)})).catch((function(t){return console.error("Card addition error:",t)}))})),s.profileAvatar.addEventListener("click",(function(){t(s.popupChangeAvatar)})),s.avatarForm.addEventListener("submit",(function(t){var n,r,a;t.preventDefault(),(n=s.avatarInput.value,r=document.querySelector(".popup__button-change-avatar"),a=r.textContent,r.textContent="Сохранение...",fetch("".concat(o.ENDPOINT,"/users/me/avatar"),{method:"PATCH",headers:o.headers,body:JSON.stringify({avatar:n})}).then((function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))})).catch((function(t){console.error("Ошибка при добавлении новой карточки:",t)})).finally((function(){r.textContent=a}))).then((function(t){s.profileAvatar.style.backgroundImage="url(".concat(t.avatar,")"),e(s.popupChangeAvatar),f(s.avatarForm)})).catch((function(t){return console.error("Avatar update error:",t)}))})),document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll(".popup").forEach((function(t){t.classList.add("popup_is-animated")}))}))})();